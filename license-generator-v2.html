<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·é›¨ä¼ åª’ç½‘ç»œé…ç½®ç®¡ç†å·¥å…· - å¡å¯†ç®¡ç†ç³»ç»Ÿ V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #6c757d;
            font-size: 14px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .license-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }

        .license-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .license-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #495057;
        }

        .license-info {
            font-size: 12px;
            color: #6c757d;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #0056b3;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        /* æŒ‰é’®å°ºå¯¸ */
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-used {
            background: #f8d7da;
            color: #721c24;
        }

        .status-expired {
            background: #fff3cd;
            color: #856404;
        }

        .status-disabled {
            background: #e2e3e5;
            color: #383d41;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« é›·é›¨ä¼ åª’å¡å¯†ç®¡ç†ç³»ç»Ÿ V2</h1>
            <p>ä¸“ä¸šçš„æˆæƒç ç”Ÿæˆå’Œç®¡ç†å·¥å…·</p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalGenerated">0</div>
                <div class="stat-label">å·²ç”Ÿæˆå¡å¯†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalBatches">0</div>
                <div class="stat-label">æ‰¹æ¬¡æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="serverStatus">ğŸ”´</div>
                <div class="stat-label">æœåŠ¡å™¨çŠ¶æ€</div>
            </div>
        </div>

        <!-- ç”Ÿæˆå¡å¯†è¡¨å• -->
        <div class="form-section">
            <h3>ğŸ¯ ç”Ÿæˆå¡å¯†</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="form-group">
                    <label for="licenseLevel">æˆæƒçº§åˆ«</label>
                    <select id="licenseLevel" class="form-control">
                        <option value="basic">ğŸ¥‰ åŸºç¡€ç‰ˆ (æœ€å¤š10ä¸ªèŠ‚ç‚¹)</option>
                        <option value="professional" selected>ğŸ¥ˆ ä¸“ä¸šç‰ˆ (æœ€å¤š100ä¸ªèŠ‚ç‚¹)</option>
                        <option value="enterprise">ğŸ¥‡ ä¼ä¸šç‰ˆ (æ— é™èŠ‚ç‚¹)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="validityDays">æœ‰æ•ˆæœŸ (å¤©)</label>
                    <select id="validityDays" class="form-control">
                        <option value="7">7å¤©</option>
                        <option value="30" selected>30å¤©</option>
                        <option value="90">90å¤©</option>
                        <option value="180">180å¤©</option>
                        <option value="365">365å¤©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">ç”Ÿæˆæ•°é‡</label>
                    <input type="number" id="quantity" class="form-control" value="10" min="1" max="1000">
                </div>
                <div class="form-group">
                    <label for="batchName">æ‰¹æ¬¡åç§°</label>
                    <input type="text" id="batchName" class="form-control" placeholder="ä¾‹å¦‚ï¼š2025å¹´1æœˆæ‰¹æ¬¡">
                </div>
            </div>
            <button class="btn btn-primary" onclick="generateLicenses()" style="width: 100%; margin-top: 15px;">
                ğŸ¯ ç”Ÿæˆå¡å¯†
            </button>
        </div>

        <!-- åŠŸèƒ½æŒ‰é’® -->
        <div class="button-grid">
            <button class="btn btn-success" onclick="generateTestLicenses()">ğŸ§ª ç”Ÿæˆæµ‹è¯•å¡å¯†</button>
            <button class="btn btn-info" onclick="verifyLicenseCode()">ğŸ” éªŒè¯å¡å¯†</button>
            <button class="btn btn-warning" onclick="showUsedLicenses()">ğŸ“Š æŸ¥çœ‹å·²ä½¿ç”¨å¡å¯†</button>
            <button class="btn btn-secondary" onclick="checkLicenseStatus()">ğŸ” æ£€æŸ¥å¡å¯†çŠ¶æ€</button>
            <button class="btn btn-primary" onclick="uploadToServer()">ğŸ“¤ ä¸Šä¼ åˆ°æœåŠ¡å™¨</button>
            <button class="btn btn-success" onclick="checkServerStatus()">ğŸŒ æœåŠ¡å™¨çŠ¶æ€</button>
            <button class="btn btn-info" onclick="showServerStats()">ğŸ“ˆ æœåŠ¡å™¨ç»Ÿè®¡</button>
            <button class="btn btn-secondary" onclick="manageServerLicenses()">ğŸ—‚ï¸ æœåŠ¡å™¨ç®¡ç†</button>
            <button class="btn btn-primary" onclick="showLicenseManager()">ğŸ› ï¸ å¡å¯†ç®¡ç†</button>
            <button class="btn btn-warning" onclick="exportLicenses()">ğŸ“„ å¯¼å‡ºå¡å¯†</button>
            <button class="btn btn-danger" onclick="clearLicenses()">ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="messageArea"></div>

        <!-- å¡å¯†åˆ—è¡¨ -->
        <div class="license-list">
            <h3>ğŸ“‹ ç”Ÿæˆçš„å¡å¯†åˆ—è¡¨</h3>
            <div id="licenseList">
                <p style="text-align: center; color: #6c757d; padding: 20px;">æš‚æ— å¡å¯†ï¼Œè¯·å…ˆç”Ÿæˆå¡å¯†</p>
            </div>
        </div>

        <!-- å¡å¯†ç®¡ç†æ¨¡æ€æ¡† -->
        <div id="licenseManagerModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1200px; width: 90%;">
                <div class="modal-header">
                    <h2>ğŸ› ï¸ å¡å¯†ç®¡ç†ç³»ç»Ÿ</h2>
                    <span class="close" onclick="closeLicenseManager()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
                    <div class="search-controls" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢å¡å¯†æˆ–æ‰¹æ¬¡åç§°..."
                                   style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="statusFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="active">æ´»è·ƒ</option>
                                <option value="used">å·²ä½¿ç”¨</option>
                                <option value="expired">å·²è¿‡æœŸ</option>
                                <option value="disabled">å·²ç¦ç”¨</option>
                            </select>
                            <button onclick="searchServerLicenses()" class="btn btn-primary">ğŸ” æœç´¢</button>
                            <button onclick="refreshLicenseList()" class="btn btn-secondary">ğŸ”„ åˆ·æ–°</button>
                        </div>
                    </div>

                    <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
                    <div class="batch-controls" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <span>æ‰¹é‡æ“ä½œ:</span>
                            <button onclick="selectAllLicenses()" class="btn btn-sm btn-secondary">å…¨é€‰</button>
                            <button onclick="deselectAllLicenses()" class="btn btn-sm btn-secondary">å–æ¶ˆå…¨é€‰</button>
                            <button onclick="batchDeleteSelected()" class="btn btn-sm btn-danger">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                            <select id="batchStatusSelect" style="padding: 4px;">
                                <option value="">é€‰æ‹©çŠ¶æ€</option>
                                <option value="active">è®¾ä¸ºæ´»è·ƒ</option>
                                <option value="disabled">è®¾ä¸ºç¦ç”¨</option>
                                <option value="expired">è®¾ä¸ºè¿‡æœŸ</option>
                            </select>
                            <button onclick="batchUpdateStatus()" class="btn btn-sm btn-warning">ğŸ”„ æ‰¹é‡æ›´æ–°çŠ¶æ€</button>
                        </div>
                    </div>

                    <!-- å¡å¯†åˆ—è¡¨ -->
                    <div class="server-license-list" style="max-height: 500px; overflow-y: auto;">
                        <table id="serverLicenseTable" style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; border: 1px solid #ddd; width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">å¡å¯†</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">çŠ¶æ€</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">æ‰¹æ¬¡</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">æœ‰æ•ˆæœŸ</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">åˆ›å»ºæ—¶é—´</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="serverLicenseTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">
                                        ğŸ” ç‚¹å‡»æœç´¢æŒ‰é’®åŠ è½½å¡å¯†åˆ—è¡¨
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- åˆ†é¡µæ§åˆ¶ -->
                    <div class="pagination-controls" style="margin-top: 20px; text-align: center;">
                        <button onclick="previousPage()" class="btn btn-sm btn-secondary" id="prevPageBtn" disabled>ä¸Šä¸€é¡µ</button>
                        <span id="pageInfo" style="margin: 0 15px;">ç¬¬ 1 é¡µ</span>
                        <button onclick="nextPage()" class="btn btn-sm btn-secondary" id="nextPageBtn" disabled>ä¸‹ä¸€é¡µ</button>
                        <span style="margin-left: 20px;">æ¯é¡µæ˜¾ç¤º:</span>
                        <select id="pageSizeSelect" onchange="changePageSize()" style="margin-left: 5px; padding: 4px;">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¡å¯†ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="editLicenseModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; width: 90%;">
                <div class="modal-header">
                    <h2>âœï¸ ç¼–è¾‘å¡å¯†</h2>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label><strong>å¡å¯†ä»£ç :</strong></label>
                        <div id="editLicenseCode" style="font-family: monospace; font-size: 14px; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;"></div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="editStatusSelect"><strong>çŠ¶æ€:</strong></label>
                        <select id="editStatusSelect" class="form-control" style="margin-top: 5px;">
                            <option value="active">ğŸŸ¢ æ´»è·ƒ</option>
                            <option value="used">ğŸ”´ å·²ä½¿ç”¨</option>
                            <option value="expired">ğŸŸ¡ å·²è¿‡æœŸ</option>
                            <option value="disabled">âš« å·²ç¦ç”¨</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label><strong>å½“å‰ä¿¡æ¯:</strong></label>
                        <div id="editLicenseInfo" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; font-size: 12px;"></div>
                    </div>

                    <div style="text-align: right; margin-top: 30px;">
                        <button onclick="closeEditModal()" class="btn btn-secondary" style="margin-right: 10px;">å–æ¶ˆ</button>
                        <button onclick="saveEditedLicense()" class="btn btn-primary">ğŸ’¾ ä¿å­˜æ›´æ”¹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let generatedLicenses = [];
        let ipcRenderer = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // å°è¯•è·å– Electron çš„ ipcRenderer
                if (typeof require !== 'undefined') {
                    const { ipcRenderer: electronIpcRenderer } = require('electron');
                    ipcRenderer = electronIpcRenderer;
                    console.log('âœ… Electron ç¯å¢ƒæ£€æµ‹æˆåŠŸ');
                } else {
                    console.log('âš ï¸ é Electron ç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
                }
            } catch (error) {
                console.log('âš ï¸ æ— æ³•åŠ è½½ Electron æ¨¡å—ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
            }

            // åˆå§‹åŒ–æ‰¹æ¬¡åç§°
            const now = new Date();
            const defaultBatchName = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆæ‰¹æ¬¡`;
            document.getElementById('batchName').value = defaultBatchName;

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageArea.appendChild(messageDiv);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalGenerated').textContent = generatedLicenses.length;

            const batches = new Set(generatedLicenses.map(license => license.batchId));
            document.getElementById('totalBatches').textContent = batches.size;
        }

        // ç”Ÿæˆå¡å¯†
        async function generateLicenses() {
            const licenseLevel = document.getElementById('licenseLevel').value;
            const validityDays = parseInt(document.getElementById('validityDays').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const batchName = document.getElementById('batchName').value.trim() || 'æœªå‘½åæ‰¹æ¬¡';

            if (quantity < 1 || quantity > 1000) {
                showMessage('âŒ ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-1000ä¹‹é—´', 'error');
                return;
            }

            try {
                showMessage('ğŸ¯ æ­£åœ¨ç”Ÿæˆå¡å¯†...', 'success');

                if (ipcRenderer) {
                    // Electron ç¯å¢ƒ
                    const result = await ipcRenderer.invoke('generate-batch-licenses', {
                        licenseLevel,
                        validityDays,
                        quantity,
                        batchName
                    });

                    if (result.success) {
                        generatedLicenses.push(...result.licenses);
                        showMessage(`âœ… æˆåŠŸç”Ÿæˆ ${result.licenses.length} ä¸ªå¡å¯†`, 'success');
                        updateLicenseList();
                        updateStats();
                    } else {
                        showMessage(`âŒ ç”Ÿæˆå¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹Ÿç¯å¢ƒ
                    const mockLicenses = [];
                    const batchId = Date.now();

                    for (let i = 0; i < quantity; i++) {
                        const code = generateMockLicenseCode();
                        mockLicenses.push({
                            id: `${batchId}-${i + 1}`,
                            code: code,
                            licenseLevel: licenseLevel,
                            validityDays: validityDays,
                            batchName: batchName,
                            batchId: batchId,
                            generatedAt: new Date()
                        });
                    }

                    generatedLicenses.push(...mockLicenses);
                    showMessage(`âœ… æ¨¡æ‹Ÿç”Ÿæˆ ${mockLicenses.length} ä¸ªå¡å¯†`, 'success');
                    updateLicenseList();
                    updateStats();
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¡å¯†å¤±è´¥:', error);
                showMessage(`âŒ ç”Ÿæˆå¡å¯†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿå¡å¯†ä»£ç 
        function generateMockLicenseCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 20; i++) {
                if (i > 0 && i % 4 === 0) result += '-';
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // æ›´æ–°å¡å¯†åˆ—è¡¨æ˜¾ç¤º
        function updateLicenseList() {
            const licenseList = document.getElementById('licenseList');

            if (generatedLicenses.length === 0) {
                licenseList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">æš‚æ— å¡å¯†ï¼Œè¯·å…ˆç”Ÿæˆå¡å¯†</p>';
                return;
            }

            const html = generatedLicenses.map(license => `
                <div class="license-item">
                    <div>
                        <div class="license-code">${license.code}</div>
                        <div class="license-info">
                            ${getLevelName(license.licenseLevel)} | ${license.validityDays}å¤©æœ‰æ•ˆæœŸ | ${license.batchName}<br>
                            ç”Ÿæˆæ—¶é—´: ${license.generatedAt.toLocaleString()}
                        </div>
                    </div>
                    <button class="copy-btn" onclick="copyLicense('${license.code}')">å¤åˆ¶</button>
                </div>
            `).join('');

            licenseList.innerHTML = html;
        }

        // è·å–çº§åˆ«åç§°
        function getLevelName(level) {
            const levels = {
                basic: 'ğŸ¥‰ åŸºç¡€ç‰ˆ',
                professional: 'ğŸ¥ˆ ä¸“ä¸šç‰ˆ',
                enterprise: 'ğŸ¥‡ ä¼ä¸šç‰ˆ'
            };
            return levels[level] || 'ğŸ¥ˆ ä¸“ä¸šç‰ˆ';
        }

        // å¤åˆ¶å¡å¯†
        function copyLicense(code) {
            navigator.clipboard.writeText(code).then(() => {
                showMessage(`âœ… å¡å¯†å·²å¤åˆ¶: ${code}`, 'success');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage(`âœ… å¡å¯†å·²å¤åˆ¶: ${code}`, 'success');
            });
        }

        // ç”Ÿæˆæµ‹è¯•å¡å¯†
        async function generateTestLicenses() {
            try {
                showMessage('ğŸ§ª æ­£åœ¨ç”Ÿæˆæµ‹è¯•å¡å¯†...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('generate-test-licenses');
                    if (result.success) {
                        const testLicenses = result.licenses.map(license => ({
                            id: `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            code: license.code,
                            licenseLevel: license.licenseLevel,
                            validityDays: license.validityDays,
                            batchName: `æµ‹è¯•æ‰¹æ¬¡-${license.name}`,
                            batchId: `test-${Date.now()}`,
                            generatedAt: new Date()
                        }));

                        generatedLicenses.push(...testLicenses);
                        showMessage(`âœ… æˆåŠŸç”Ÿæˆ ${testLicenses.length} ä¸ªæµ‹è¯•å¡å¯†`, 'success');
                        updateLicenseList();
                        updateStats();
                    } else {
                        showMessage(`âŒ ç”Ÿæˆæµ‹è¯•å¡å¯†å¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹Ÿæµ‹è¯•å¡å¯†
                    const testConfigs = [
                        { days: 7, level: 'basic', name: '7å¤©åŸºç¡€ç‰ˆ' },
                        { days: 30, level: 'professional', name: '30å¤©ä¸“ä¸šç‰ˆ' },
                        { days: 90, level: 'professional', name: '90å¤©ä¸“ä¸šç‰ˆ' },
                        { days: 365, level: 'enterprise', name: '365å¤©ä¼ä¸šç‰ˆ' }
                    ];

                    const testLicenses = testConfigs.map(config => ({
                        id: `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        code: generateMockLicenseCode(),
                        licenseLevel: config.level,
                        validityDays: config.days,
                        batchName: `æµ‹è¯•æ‰¹æ¬¡-${config.name}`,
                        batchId: `test-${Date.now()}`,
                        generatedAt: new Date()
                    }));

                    generatedLicenses.push(...testLicenses);
                    showMessage(`âœ… æ¨¡æ‹Ÿç”Ÿæˆ ${testLicenses.length} ä¸ªæµ‹è¯•å¡å¯†`, 'success');
                    updateLicenseList();
                    updateStats();
                }
            } catch (error) {
                console.error('ç”Ÿæˆæµ‹è¯•å¡å¯†å¤±è´¥:', error);
                showMessage(`âŒ ç”Ÿæˆæµ‹è¯•å¡å¯†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // éªŒè¯å¡å¯†
        async function verifyLicenseCode() {
            const licenseCode = prompt('ğŸ” è¯·è¾“å…¥è¦éªŒè¯çš„å¡å¯†:');
            if (!licenseCode) return;

            try {
                showMessage('ğŸ” æ­£åœ¨éªŒè¯å¡å¯†...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('verify-license-code', licenseCode.trim());
                    if (result.success) {
                        const verification = result.result;
                        if (verification.valid) {
                            const message = `âœ… å¡å¯†éªŒè¯æˆåŠŸï¼\n\nå¡å¯†: ${licenseCode}\nçŠ¶æ€: ${verification.message}`;
                            alert(message);
                            showMessage('âœ… å¡å¯†éªŒè¯æˆåŠŸ', 'success');
                        } else {
                            const message = `âŒ å¡å¯†éªŒè¯å¤±è´¥ï¼\n\nå¡å¯†: ${licenseCode}\nåŸå› : ${verification.message}`;
                            alert(message);
                            showMessage('âŒ å¡å¯†éªŒè¯å¤±è´¥', 'error');
                        }
                    } else {
                        showMessage(`âŒ éªŒè¯å¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹ŸéªŒè¯
                    const isValid = Math.random() > 0.3; // 70% æ¦‚ç‡æœ‰æ•ˆ
                    const message = isValid
                        ? `âœ… å¡å¯†éªŒè¯æˆåŠŸï¼\n\nå¡å¯†: ${licenseCode}\nçŠ¶æ€: æ¨¡æ‹ŸéªŒè¯é€šè¿‡`
                        : `âŒ å¡å¯†éªŒè¯å¤±è´¥ï¼\n\nå¡å¯†: ${licenseCode}\nåŸå› : æ¨¡æ‹ŸéªŒè¯å¤±è´¥`;
                    alert(message);
                    showMessage(isValid ? 'âœ… æ¨¡æ‹ŸéªŒè¯æˆåŠŸ' : 'âŒ æ¨¡æ‹ŸéªŒè¯å¤±è´¥', isValid ? 'success' : 'error');
                }
            } catch (error) {
                console.error('éªŒè¯å¡å¯†å¤±è´¥:', error);
                showMessage(`âŒ éªŒè¯å¡å¯†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹å·²ä½¿ç”¨å¡å¯†
        async function showUsedLicenses() {
            try {
                showMessage('ğŸ“Š æ­£åœ¨è·å–å·²ä½¿ç”¨å¡å¯†åˆ—è¡¨...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('get-used-licenses');
                    if (result.success) {
                        const usedLicenses = result.usedLicenses;
                        if (usedLicenses.length === 0) {
                            alert('ğŸ“Š æš‚æ— å·²ä½¿ç”¨çš„å¡å¯†');
                        } else {
                            const message = `ğŸ“Š å·²ä½¿ç”¨å¡å¯†åˆ—è¡¨ (${usedLicenses.length}ä¸ª)\n\n` +
                                usedLicenses.slice(0, 10).map(license =>
                                    `${license.code} - ${license.usedAt ? new Date(license.usedAt).toLocaleString() : 'æœªçŸ¥æ—¶é—´'}`
                                ).join('\n') +
                                (usedLicenses.length > 10 ? `\n\n... è¿˜æœ‰ ${usedLicenses.length - 10} ä¸ª` : '');
                            alert(message);
                        }
                        showMessage(`âœ… è·å–åˆ° ${usedLicenses.length} ä¸ªå·²ä½¿ç”¨å¡å¯†`, 'success');
                    } else {
                        showMessage(`âŒ è·å–å¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹Ÿå·²ä½¿ç”¨å¡å¯†
                    const mockUsedCount = Math.floor(Math.random() * 20);
                    alert(`ğŸ“Š æ¨¡æ‹Ÿå·²ä½¿ç”¨å¡å¯†åˆ—è¡¨\n\nå…± ${mockUsedCount} ä¸ªå·²ä½¿ç”¨çš„å¡å¯†`);
                    showMessage(`âœ… æ¨¡æ‹Ÿè·å–åˆ° ${mockUsedCount} ä¸ªå·²ä½¿ç”¨å¡å¯†`, 'success');
                }
            } catch (error) {
                console.error('è·å–å·²ä½¿ç”¨å¡å¯†å¤±è´¥:', error);
                showMessage(`âŒ è·å–å·²ä½¿ç”¨å¡å¯†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥å¡å¯†çŠ¶æ€
        async function checkLicenseStatus() {
            const licenseCode = prompt('ğŸ” è¯·è¾“å…¥è¦æ£€æŸ¥çš„å¡å¯†:');
            if (!licenseCode) return;

            try {
                showMessage('ğŸ” æ­£åœ¨æ£€æŸ¥å¡å¯†çŠ¶æ€...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('check-license-status', licenseCode.trim());
                    if (result.success) {
                        const { isUsed, verification } = result;
                        const statusMessage = `ğŸ” å¡å¯†çŠ¶æ€æ£€æŸ¥ç»“æœ\n\n` +
                            `å¡å¯†: ${licenseCode}\n` +
                            `çŠ¶æ€: ${isUsed ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}\n` +
                            `æœ‰æ•ˆæ€§: ${verification.valid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}\n` +
                            `æ¶ˆæ¯: ${verification.message}`;
                        alert(statusMessage);
                        showMessage('âœ… å¡å¯†çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
                    } else {
                        showMessage(`âŒ æ£€æŸ¥å¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹ŸçŠ¶æ€æ£€æŸ¥
                    const isUsed = Math.random() > 0.5;
                    const isValid = Math.random() > 0.3;
                    const statusMessage = `ğŸ” æ¨¡æ‹Ÿå¡å¯†çŠ¶æ€æ£€æŸ¥\n\n` +
                        `å¡å¯†: ${licenseCode}\n` +
                        `çŠ¶æ€: ${isUsed ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}\n` +
                        `æœ‰æ•ˆæ€§: ${isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}`;
                    alert(statusMessage);
                    showMessage('âœ… æ¨¡æ‹ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¡å¯†çŠ¶æ€å¤±è´¥:', error);
                showMessage(`âŒ æ£€æŸ¥å¡å¯†çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¸Šä¼ åˆ°æœåŠ¡å™¨
        async function uploadToServer() {
            if (generatedLicenses.length === 0) {
                showMessage('âŒ æ²¡æœ‰å¯ä¸Šä¼ çš„å¡å¯†ï¼Œè¯·å…ˆç”Ÿæˆå¡å¯†', 'error');
                return;
            }

            try {
                showMessage('ğŸ“¤ æ­£åœ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨...', 'success');

                if (ipcRenderer) {
                    const uploadData = generatedLicenses.map(license => ({
                        code: license.code,
                        licenseLevel: license.licenseLevel,
                        validityDays: license.validityDays,
                        batchName: license.batchName,
                        generatedAt: license.generatedAt,
                        batchId: license.batchId
                    }));

                    const result = await ipcRenderer.invoke('upload-batch-licenses', {
                        licenses: uploadData,
                        batchName: uploadData[0]?.batchName || 'æœªå‘½åæ‰¹æ¬¡'
                    });

                    if (result.success) {
                        showMessage(`âœ… æˆåŠŸä¸Šä¼  ${uploadData.length} ä¸ªå¡å¯†åˆ°æœåŠ¡å™¨`, 'success');
                    } else {
                        showMessage(`âŒ ä¸Šä¼ å¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹Ÿä¸Šä¼ 
                    await new Promise(resolve => setTimeout(resolve, 1000)); // æ¨¡æ‹Ÿå»¶è¿Ÿ
                    showMessage(`âœ… æ¨¡æ‹Ÿä¸Šä¼  ${generatedLicenses.length} ä¸ªå¡å¯†åˆ°æœåŠ¡å™¨`, 'success');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showMessage(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                showMessage('ğŸ” æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('check-server-health');
                    if (result.success) {
                        const status = result.online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
                        const message = `ğŸŒ æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥ç»“æœ\n\nçŠ¶æ€: ${status}\næ¶ˆæ¯: ${result.message}\næ—¶é—´: ${new Date().toLocaleString()}`;
                        alert(message);

                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        document.getElementById('serverStatus').textContent = result.online ? 'ğŸŸ¢' : 'ğŸ”´';
                        showMessage(`âœ… æœåŠ¡å™¨${result.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}`, 'success');
                    } else {
                        showMessage(`âŒ æ£€æŸ¥å¤±è´¥: ${result.message}`, 'error');
                        document.getElementById('serverStatus').textContent = 'ğŸ”´';
                    }
                } else {
                    // æ¨¡æ‹ŸæœåŠ¡å™¨çŠ¶æ€
                    const isOnline = Math.random() > 0.2; // 80% æ¦‚ç‡åœ¨çº¿
                    const status = isOnline ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
                    const message = `ğŸŒ æ¨¡æ‹ŸæœåŠ¡å™¨çŠ¶æ€\n\nçŠ¶æ€: ${status}\næ—¶é—´: ${new Date().toLocaleString()}`;
                    alert(message);

                    document.getElementById('serverStatus').textContent = isOnline ? 'ğŸŸ¢' : 'ğŸ”´';
                    showMessage(`âœ… æ¨¡æ‹ŸæœåŠ¡å™¨${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`, 'success');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);
                showMessage(`âŒ æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('serverStatus').textContent = 'ğŸ”´';
            }
        }

        // æ˜¾ç¤ºæœåŠ¡å™¨ç»Ÿè®¡
        async function showServerStats() {
            try {
                showMessage('ğŸ“Š æ­£åœ¨è·å–æœåŠ¡å™¨ç»Ÿè®¡...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('get-server-stats');
                    if (result.success) {
                        const stats = result.data;
                        const message = `ğŸ“Š æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯\n\n` +
                            `æ€»å¡å¯†æ•°: ${stats.totalLicenses || 0}\n` +
                            `å·²ä½¿ç”¨: ${stats.usedLicenses || 0}\n` +
                            `æœªä½¿ç”¨: ${stats.unusedLicenses || 0}\n` +
                            `ä»Šæ—¥ç”Ÿæˆ: ${stats.todayGenerated || 0}\n` +
                            `æœåŠ¡å™¨ç‰ˆæœ¬: ${stats.version || 'æœªçŸ¥'}`;
                        alert(message);
                        showMessage('âœ… è·å–æœåŠ¡å™¨ç»Ÿè®¡æˆåŠŸ', 'success');
                    } else {
                        showMessage(`âŒ è·å–å¤±è´¥: ${result.message}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹Ÿç»Ÿè®¡æ•°æ®
                    const mockStats = {
                        totalLicenses: Math.floor(Math.random() * 1000) + 100,
                        usedLicenses: Math.floor(Math.random() * 200) + 50,
                        unusedLicenses: Math.floor(Math.random() * 800) + 50,
                        todayGenerated: Math.floor(Math.random() * 50) + 10
                    };
                    const message = `ğŸ“Š æ¨¡æ‹ŸæœåŠ¡å™¨ç»Ÿè®¡\n\n` +
                        `æ€»å¡å¯†æ•°: ${mockStats.totalLicenses}\n` +
                        `å·²ä½¿ç”¨: ${mockStats.usedLicenses}\n` +
                        `æœªä½¿ç”¨: ${mockStats.unusedLicenses}\n` +
                        `ä»Šæ—¥ç”Ÿæˆ: ${mockStats.todayGenerated}`;
                    alert(message);
                    showMessage('âœ… æ¨¡æ‹Ÿç»Ÿè®¡æ•°æ®è·å–æˆåŠŸ', 'success');
                }
            } catch (error) {
                console.error('è·å–æœåŠ¡å™¨ç»Ÿè®¡å¤±è´¥:', error);
                showMessage(`âŒ è·å–æœåŠ¡å™¨ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æœåŠ¡å™¨ç®¡ç†
        async function manageServerLicenses() {
            try {
                showMessage('ğŸ—‚ï¸ æ­£åœ¨è·å–æœåŠ¡å™¨å¡å¯†åˆ—è¡¨...', 'success');

                if (ipcRenderer) {
                    const result = await ipcRenderer.invoke('get-server-licenses');
                    if (result.success) {
                        const licenses = result.data;
                        if (licenses.length === 0) {
                            alert('ğŸ—‚ï¸ æœåŠ¡å™¨ä¸Šæš‚æ— å¡å¯†');
                        } else {
                            const message = `ğŸ—‚ï¸ æœåŠ¡å™¨å¡å¯†ç®¡ç† (${licenses.length}ä¸ª)\n\n` +
                                licenses.slice(0, 10).map(license =>
                                    `${license.code} - ${license.status || 'æœªçŸ¥çŠ¶æ€'}`
                                ).join('\n') +
                                (licenses.length > 10 ? `\n\n... è¿˜æœ‰ ${licenses.length - 10} ä¸ª` : '');
                            alert(message);
                        }
                        showMessage(`âœ… è·å–åˆ° ${licenses.length} ä¸ªæœåŠ¡å™¨å¡å¯†`, 'success');
                    } else {
                        showMessage(`âŒ è·å–å¤±è´¥: ${result.message}`, 'error');
                    }
                } else {
                    // æ¨¡æ‹ŸæœåŠ¡å™¨ç®¡ç†
                    const mockCount = Math.floor(Math.random() * 100) + 20;
                    alert(`ğŸ—‚ï¸ æ¨¡æ‹ŸæœåŠ¡å™¨å¡å¯†ç®¡ç†\n\næœåŠ¡å™¨ä¸Šå…±æœ‰ ${mockCount} ä¸ªå¡å¯†`);
                    showMessage(`âœ… æ¨¡æ‹Ÿè·å–åˆ° ${mockCount} ä¸ªæœåŠ¡å™¨å¡å¯†`, 'success');
                }
            } catch (error) {
                console.error('æœåŠ¡å™¨ç®¡ç†å¤±è´¥:', error);
                showMessage(`âŒ æœåŠ¡å™¨ç®¡ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯¼å‡ºå¡å¯†
        function exportLicenses() {
            if (generatedLicenses.length === 0) {
                showMessage('âŒ æ²¡æœ‰å¯å¯¼å‡ºçš„å¡å¯†ï¼Œè¯·å…ˆç”Ÿæˆå¡å¯†', 'error');
                return;
            }

            try {
                const exportData = generatedLicenses.map(license =>
                    `${license.code}\t${getLevelName(license.licenseLevel)}\t${license.validityDays}å¤©\t${license.batchName}\t${license.generatedAt.toLocaleString()}`
                ).join('\n');

                const header = 'å¡å¯†\tçº§åˆ«\tæœ‰æ•ˆæœŸ\tæ‰¹æ¬¡\tç”Ÿæˆæ—¶é—´\n';
                const fullData = header + exportData;

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([fullData], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å¡å¯†åˆ—è¡¨_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage(`âœ… æˆåŠŸå¯¼å‡º ${generatedLicenses.length} ä¸ªå¡å¯†`, 'success');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showMessage(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºå¡å¯†åˆ—è¡¨
        function clearLicenses() {
            if (generatedLicenses.length === 0) {
                showMessage('âŒ åˆ—è¡¨å·²ç»æ˜¯ç©ºçš„', 'error');
                return;
            }

            if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${generatedLicenses.length} ä¸ªå¡å¯†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                generatedLicenses = [];
                updateLicenseList();
                updateStats();
                showMessage('âœ… å·²æ¸…ç©ºå¡å¯†åˆ—è¡¨', 'success');
            }
        }

        // ===== å¡å¯†ç®¡ç†ç³»ç»Ÿ =====
        let currentPage = 1;
        let pageSize = 50;
        let totalLicenses = 0;
        let serverLicenses = [];
        let selectedLicenses = new Set();

        // æ˜¾ç¤ºå¡å¯†ç®¡ç†å™¨
        function showLicenseManager() {
            document.getElementById('licenseManagerModal').style.display = 'flex';
            refreshLicenseList();
        }

        // å…³é—­å¡å¯†ç®¡ç†å™¨
        function closeLicenseManager() {
            document.getElementById('licenseManagerModal').style.display = 'none';
            selectedLicenses.clear();
        }

        // åˆ·æ–°å¡å¯†åˆ—è¡¨
        async function refreshLicenseList() {
            await searchServerLicenses();
        }

        // æœç´¢æœåŠ¡å™¨å¡å¯†
        async function searchServerLicenses() {
            try {
                const searchTerm = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;

                showMessage('ğŸ” æ­£åœ¨æœç´¢å¡å¯†...', 'info');

                const options = {
                    limit: pageSize,
                    offset: (currentPage - 1) * pageSize
                };

                if (status) options.status = status;

                let result;
                if (ipcRenderer) {
                    if (searchTerm) {
                        result = await ipcRenderer.invoke('search-licenses', {
                            searchTerm: searchTerm,
                            options: options
                        });
                    } else {
                        result = await ipcRenderer.invoke('get-server-licenses', options);
                    }
                } else {
                    // æ¨¡æ‹Ÿæ•°æ®
                    result = {
                        success: true,
                        data: generateMockLicenses(pageSize),
                        total: 150
                    };
                }

                if (result.success) {
                    serverLicenses = result.data || [];
                    totalLicenses = result.total || serverLicenses.length;
                    updateLicenseTable();
                    updatePagination();
                    showMessage(`âœ… æ‰¾åˆ° ${totalLicenses} ä¸ªå¡å¯†`, 'success');
                } else {
                    showMessage(`âŒ æœç´¢å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('æœç´¢å¡å¯†å¤±è´¥:', error);
                showMessage(`âŒ æœç´¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿå¡å¯†æ•°æ®
        function generateMockLicenses(count) {
            const licenses = [];
            const statuses = ['active', 'used', 'expired', 'disabled'];
            const levels = ['basic', 'professional', 'enterprise'];

            for (let i = 0; i < count; i++) {
                licenses.push({
                    license_code: `LY${Date.now()}${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    level: levels[Math.floor(Math.random() * levels.length)],
                    batch_name: `æµ‹è¯•æ‰¹æ¬¡${Math.floor(Math.random() * 10) + 1}`,
                    valid_until: new Date(Date.now() + Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                });
            }
            return licenses;
        }

        // æ›´æ–°å¡å¯†è¡¨æ ¼
        function updateLicenseTable() {
            const tbody = document.getElementById('serverLicenseTableBody');

            if (serverLicenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">
                            ğŸ“­ æ²¡æœ‰æ‰¾åˆ°å¡å¯†
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = serverLicenses.map(license => `
                <tr>
                    <td>
                        <input type="checkbox" value="${license.license_code}"
                               onchange="toggleLicenseSelection('${license.license_code}')"
                               ${selectedLicenses.has(license.license_code) ? 'checked' : ''}>
                    </td>
                    <td style="font-family: monospace; font-size: 12px;">${license.license_code}</td>
                    <td>
                        <span class="status-badge status-${license.status}">
                            ${getStatusText(license.status)}
                        </span>
                    </td>
                    <td>${license.batch_name || '-'}</td>
                    <td>${license.valid_until || '-'}</td>
                    <td>${license.created_at || '-'}</td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <select onchange="quickUpdateStatus('${license.license_code}', this.value)"
                                    class="btn btn-sm" style="padding: 2px 4px; font-size: 11px;">
                                <option value="">å¿«é€ŸçŠ¶æ€</option>
                                <option value="active" ${license.status === 'active' ? 'selected' : ''}>æ´»è·ƒ</option>
                                <option value="used" ${license.status === 'used' ? 'selected' : ''}>å·²ä½¿ç”¨</option>
                                <option value="expired" ${license.status === 'expired' ? 'selected' : ''}>å·²è¿‡æœŸ</option>
                                <option value="disabled" ${license.status === 'disabled' ? 'selected' : ''}>å·²ç¦ç”¨</option>
                            </select>
                            <button onclick="openEditModal('${license.license_code}')"
                                    class="btn btn-sm btn-info" title="è¯¦ç»†ç¼–è¾‘">âœï¸</button>
                            <button onclick="deleteSingleLicense('${license.license_code}')"
                                    class="btn btn-sm btn-danger" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'active': 'æ´»è·ƒ',
                'used': 'å·²ä½¿ç”¨',
                'expired': 'å·²è¿‡æœŸ',
                'disabled': 'å·²ç¦ç”¨'
            };
            return statusMap[status] || status;
        }

        // åˆ‡æ¢å¡å¯†é€‰æ‹©
        function toggleLicenseSelection(licenseCode) {
            if (selectedLicenses.has(licenseCode)) {
                selectedLicenses.delete(licenseCode);
            } else {
                selectedLicenses.add(licenseCode);
            }
            updateSelectAllCheckbox();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox.checked) {
                selectAllLicenses();
            } else {
                deselectAllLicenses();
            }
        }

        // å…¨é€‰
        function selectAllLicenses() {
            serverLicenses.forEach(license => {
                selectedLicenses.add(license.license_code);
            });
            updateLicenseTable();
            updateSelectAllCheckbox();
        }

        // å–æ¶ˆå…¨é€‰
        function deselectAllLicenses() {
            selectedLicenses.clear();
            updateLicenseTable();
            updateSelectAllCheckbox();
        }

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const visibleLicenses = serverLicenses.map(l => l.license_code);
            const selectedVisible = visibleLicenses.filter(code => selectedLicenses.has(code));

            if (selectedVisible.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedVisible.length === visibleLicenses.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // åˆ é™¤å•ä¸ªå¡å¯†
        async function deleteSingleLicense(licenseCode) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¡å¯† ${licenseCode} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                showMessage('ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤å¡å¯†...', 'info');

                let result;
                if (ipcRenderer) {
                    result = await ipcRenderer.invoke('delete-license', licenseCode);
                } else {
                    // æ¨¡æ‹Ÿåˆ é™¤
                    result = { success: true, message: 'æ¨¡æ‹Ÿåˆ é™¤æˆåŠŸ' };
                }

                if (result.success) {
                    showMessage(`âœ… å¡å¯†åˆ é™¤æˆåŠŸ`, 'success');
                    await refreshLicenseList();
                } else {
                    showMessage(`âŒ åˆ é™¤å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¡å¯†å¤±è´¥:', error);
                showMessage(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„å¡å¯†
        async function batchDeleteSelected() {
            if (selectedLicenses.size === 0) {
                showMessage('âŒ è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å¡å¯†', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedLicenses.size} ä¸ªå¡å¯†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                showMessage(`ğŸ—‘ï¸ æ­£åœ¨æ‰¹é‡åˆ é™¤ ${selectedLicenses.size} ä¸ªå¡å¯†...`, 'info');

                const licenseCodes = Array.from(selectedLicenses);

                let result;
                if (ipcRenderer) {
                    result = await ipcRenderer.invoke('delete-batch-licenses', licenseCodes);
                } else {
                    // æ¨¡æ‹Ÿæ‰¹é‡åˆ é™¤
                    result = {
                        success: true,
                        message: `æ¨¡æ‹Ÿåˆ é™¤äº† ${licenseCodes.length} ä¸ªå¡å¯†`,
                        data: { deletedCount: licenseCodes.length }
                    };
                }

                if (result.success) {
                    showMessage(`âœ… æˆåŠŸåˆ é™¤ ${result.data?.deletedCount || licenseCodes.length} ä¸ªå¡å¯†`, 'success');
                    selectedLicenses.clear();
                    await refreshLicenseList();
                } else {
                    showMessage(`âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                showMessage(`âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¿«é€Ÿæ›´æ–°å¡å¯†çŠ¶æ€ï¼ˆé€šè¿‡ä¸‹æ‹‰é€‰æ‹©ï¼‰
        async function quickUpdateStatus(licenseCode, newStatus) {
            if (!newStatus) {
                return; // ç”¨æˆ·é€‰æ‹©äº†"ç¼–è¾‘çŠ¶æ€"é€‰é¡¹
            }

            // è·å–å½“å‰çŠ¶æ€
            const currentLicense = serverLicenses.find(l => l.license_code === licenseCode);
            const currentStatus = currentLicense ? currentLicense.status : '';

            if (newStatus === currentStatus) {
                return; // çŠ¶æ€æ²¡æœ‰æ”¹å˜
            }

            try {
                showMessage('ğŸ”„ æ­£åœ¨æ›´æ–°å¡å¯†çŠ¶æ€...', 'info');

                let result;
                if (ipcRenderer) {
                    result = await ipcRenderer.invoke('update-license-status', {
                        licenseCode: licenseCode,
                        status: newStatus
                    });
                } else {
                    // æ¨¡æ‹Ÿæ›´æ–°
                    result = { success: true, message: 'æ¨¡æ‹Ÿæ›´æ–°æˆåŠŸ' };
                }

                if (result.success) {
                    showMessage(`âœ… å¡å¯† ${licenseCode} çŠ¶æ€å·²æ›´æ–°ä¸º ${getStatusText(newStatus)}`, 'success');
                    await refreshLicenseList();
                } else {
                    showMessage(`âŒ çŠ¶æ€æ›´æ–°å¤±è´¥: ${result.message}`, 'error');
                    // æ¢å¤åŸçŠ¶æ€
                    await refreshLicenseList();
                }
            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                showMessage(`âŒ çŠ¶æ€æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
                // æ¢å¤åŸçŠ¶æ€
                await refreshLicenseList();
            }
        }

        // ç¼–è¾‘å¡å¯†çŠ¶æ€ï¼ˆä¿ç•™åŸå‡½æ•°ä½œä¸ºå¤‡ç”¨ï¼‰
        async function editLicenseStatus(licenseCode, currentStatus) {
            const statusOptions = [
                { value: 'active', text: 'æ´»è·ƒ' },
                { value: 'used', text: 'å·²ä½¿ç”¨' },
                { value: 'expired', text: 'å·²è¿‡æœŸ' },
                { value: 'disabled', text: 'å·²ç¦ç”¨' }
            ];

            let optionsText = statusOptions.map((opt, index) =>
                `${index + 1}. ${opt.text} (${opt.value})`
            ).join('\n');

            const choice = prompt(
                `è¯·é€‰æ‹©æ–°çŠ¶æ€:\n${optionsText}\n\nè¯·è¾“å…¥æ•°å­— (1-4) æˆ–ç›´æ¥è¾“å…¥çŠ¶æ€å€¼:`,
                currentStatus
            );

            if (!choice) return;

            let newStatus;
            if (/^[1-4]$/.test(choice)) {
                newStatus = statusOptions[parseInt(choice) - 1].value;
            } else {
                newStatus = choice.toLowerCase();
            }

            const validStatuses = ['active', 'used', 'expired', 'disabled'];
            if (!validStatuses.includes(newStatus)) {
                showMessage('âŒ æ— æ•ˆçš„çŠ¶æ€å€¼', 'error');
                return;
            }

            if (newStatus === currentStatus) {
                return;
            }

            try {
                showMessage('ğŸ”„ æ­£åœ¨æ›´æ–°å¡å¯†çŠ¶æ€...', 'info');

                let result;
                if (ipcRenderer) {
                    result = await ipcRenderer.invoke('update-license-status', {
                        licenseCode: licenseCode,
                        status: newStatus
                    });
                } else {
                    // æ¨¡æ‹Ÿæ›´æ–°
                    result = { success: true, message: 'æ¨¡æ‹Ÿæ›´æ–°æˆåŠŸ' };
                }

                if (result.success) {
                    showMessage(`âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ`, 'success');
                    await refreshLicenseList();
                } else {
                    showMessage(`âŒ çŠ¶æ€æ›´æ–°å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                showMessage(`âŒ çŠ¶æ€æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ===== ç¼–è¾‘æ¨¡æ€æ¡†åŠŸèƒ½ =====
        let currentEditingLicense = null;

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(licenseCode) {
            const license = serverLicenses.find(l => l.license_code === licenseCode);
            if (!license) {
                showMessage('âŒ æ‰¾ä¸åˆ°æŒ‡å®šçš„å¡å¯†', 'error');
                return;
            }

            currentEditingLicense = license;

            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('editLicenseCode').textContent = license.license_code;
            document.getElementById('editStatusSelect').value = license.status;

            // æ˜¾ç¤ºå½“å‰ä¿¡æ¯
            const infoHtml = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>å½“å‰çŠ¶æ€:</strong> <span class="status-badge status-${license.status}">${getStatusText(license.status)}</span></div>
                    <div><strong>æˆæƒçº§åˆ«:</strong> ${license.level || '-'}</div>
                    <div><strong>æ‰¹æ¬¡åç§°:</strong> ${license.batch_name || '-'}</div>
                    <div><strong>æœ‰æ•ˆæœŸè‡³:</strong> ${license.valid_until || '-'}</div>
                    <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${license.created_at || '-'}</div>
                    <div><strong>æ›´æ–°æ—¶é—´:</strong> ${license.updated_at || '-'}</div>
                </div>
            `;
            document.getElementById('editLicenseInfo').innerHTML = infoHtml;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editLicenseModal').style.display = 'flex';
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editLicenseModal').style.display = 'none';
            currentEditingLicense = null;
        }

        // ä¿å­˜ç¼–è¾‘çš„å¡å¯†
        async function saveEditedLicense() {
            if (!currentEditingLicense) {
                showMessage('âŒ æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„å¡å¯†', 'error');
                return;
            }

            const newStatus = document.getElementById('editStatusSelect').value;
            const licenseCode = currentEditingLicense.license_code;
            const oldStatus = currentEditingLicense.status;

            if (newStatus === oldStatus) {
                showMessage('â„¹ï¸ çŠ¶æ€æ²¡æœ‰æ”¹å˜', 'info');
                closeEditModal();
                return;
            }

            try {
                showMessage('ğŸ’¾ æ­£åœ¨ä¿å­˜æ›´æ”¹...', 'info');

                let result;
                if (ipcRenderer) {
                    result = await ipcRenderer.invoke('update-license-status', {
                        licenseCode: licenseCode,
                        status: newStatus
                    });
                } else {
                    // æ¨¡æ‹Ÿæ›´æ–°
                    result = {
                        success: true,
                        message: 'æ¨¡æ‹Ÿæ›´æ–°æˆåŠŸ',
                        data: {
                            oldStatus: oldStatus,
                            newStatus: newStatus,
                            license: { ...currentEditingLicense, status: newStatus }
                        }
                    };
                }

                if (result.success) {
                    showMessage(`âœ… å¡å¯† ${licenseCode} çŠ¶æ€å·²ä» ${getStatusText(oldStatus)} æ›´æ–°ä¸º ${getStatusText(newStatus)}`, 'success');
                    closeEditModal();
                    await refreshLicenseList();
                } else {
                    showMessage(`âŒ ä¿å­˜å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜ç¼–è¾‘å¤±è´¥:', error);
                showMessage(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰¹é‡æ›´æ–°çŠ¶æ€
        async function batchUpdateStatus() {
            if (selectedLicenses.size === 0) {
                showMessage('âŒ è¯·å…ˆé€‰æ‹©è¦æ›´æ–°çš„å¡å¯†', 'error');
                return;
            }

            const newStatus = document.getElementById('batchStatusSelect').value;
            if (!newStatus) {
                showMessage('âŒ è¯·é€‰æ‹©è¦æ›´æ–°çš„çŠ¶æ€', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${selectedLicenses.size} ä¸ªå¡å¯†çŠ¶æ€æ›´æ–°ä¸º ${getStatusText(newStatus)} å—ï¼Ÿ`)) {
                return;
            }

            try {
                showMessage(`ğŸ”„ æ­£åœ¨æ‰¹é‡æ›´æ–° ${selectedLicenses.size} ä¸ªå¡å¯†çŠ¶æ€...`, 'info');

                const licenseCodes = Array.from(selectedLicenses);
                let successCount = 0;
                let failCount = 0;

                for (const licenseCode of licenseCodes) {
                    try {
                        let result;
                        if (ipcRenderer) {
                            result = await ipcRenderer.invoke('update-license-status', {
                                licenseCode: licenseCode,
                                status: newStatus
                            });
                        } else {
                            // æ¨¡æ‹Ÿæ›´æ–°
                            result = { success: true };
                        }

                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }

                if (successCount > 0) {
                    showMessage(`âœ… æˆåŠŸæ›´æ–° ${successCount} ä¸ªå¡å¯†çŠ¶æ€${failCount > 0 ? `ï¼Œå¤±è´¥ ${failCount} ä¸ª` : ''}`, 'success');
                    selectedLicenses.clear();
                    await refreshLicenseList();
                } else {
                    showMessage(`âŒ æ‰¹é‡æ›´æ–°å¤±è´¥`, 'error');
                }
            } catch (error) {
                console.error('æ‰¹é‡æ›´æ–°å¤±è´¥:', error);
                showMessage(`âŒ æ‰¹é‡æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ†é¡µæ§åˆ¶
        function updatePagination() {
            const totalPages = Math.ceil(totalLicenses / pageSize);
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ (æ€»è®¡ ${totalLicenses} ä¸ª)`;

            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                searchServerLicenses();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalLicenses / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                searchServerLicenses();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            searchServerLicenses();
        }

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(event) {
            // ç¼–è¾‘æ¨¡æ€æ¡†å¿«æ·é”®
            if (document.getElementById('editLicenseModal').style.display === 'flex') {
                if (event.key === 'Escape') {
                    closeEditModal();
                } else if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    saveEditedLicense();
                }
            }
            // ç®¡ç†æ¨¡æ€æ¡†å¿«æ·é”®
            else if (document.getElementById('licenseManagerModal').style.display === 'flex') {
                if (event.key === 'Escape') {
                    closeLicenseManager();
                } else if (event.key === 'F5' || (event.ctrlKey && event.key === 'r')) {
                    event.preventDefault();
                    refreshLicenseList();
                } else if (event.ctrlKey && event.key === 'a') {
                    event.preventDefault();
                    selectAllLicenses();
                } else if (event.key === 'Delete' && selectedLicenses.size > 0) {
                    batchDeleteSelected();
                } else if (event.ctrlKey && event.key === 'f') {
                    event.preventDefault();
                    document.getElementById('searchInput').focus();
                }
            }
        });
    </script>
</body>
</html>
