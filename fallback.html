<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·é›¨ä¼ åª’ç½‘ç»œé…ç½®ç®¡ç†å·¥å…·</title>
    <link rel="stylesheet" href="components/title-bar.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: transparent;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-app-region: no-drag;
        }

        .window-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .content-area {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .logo {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .logo svg {
            width: 60px;
            height: 60px;
            color: white;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 40px;
        }

        .status {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .status h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4ade80;
        }

        .status p {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn.primary {
            background: rgba(76, 175, 80, 0.8);
            border-color: rgba(76, 175, 80, 1);
        }

        .btn.primary:hover {
            background: rgba(76, 175, 80, 1);
        }

        .network-status {
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="window-container">
        <div class="title-bar theme-gradient">
            <div class="title-bar-title">
                <svg class="title-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                é›·é›¨ä¼ åª’ç½‘ç»œé…ç½®ç®¡ç†å·¥å…·
            </div>
            <div class="title-bar-controls">
                <button class="title-bar-button minimize-btn" id="minimizeBtn"></button>
                <button class="title-bar-button close-btn" id="closeBtn"></button>
            </div>
        </div>
        <div class="content-area">
            <div class="container">
        <div class="logo">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        
        <h1>é›·é›¨ä¼ åª’é…ç½®ç®¡ç†å·¥å…·</h1>
        <p class="subtitle">ç½‘ç»œé…ç½®ç®¡ç†æ¡Œé¢ç‰ˆ</p>
        
        <div class="status">
            <h2>âœ… æˆæƒéªŒè¯æˆåŠŸ</h2>
            <p>æ‚¨çš„è½¯ä»¶æˆæƒå·²é€šè¿‡éªŒè¯ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚</p>
            <div class="license-info" id="licenseInfo" style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>æˆæƒå‰©ä½™æ—¶é—´ï¼š</span>
                    <span id="remainingDays" style="font-weight: bold; color: #4CAF50;">--</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <span>æˆæƒåˆ°æœŸæ—¥æœŸï¼š</span>
                    <span id="expireDate" style="font-size: 0.9em; color: #E0E0E0;">--</span>
                </div>
            </div>
            <div class="network-status" id="networkStatus">
                <span class="loading"></span>æ­£åœ¨è¿æ¥åˆ°ç®¡ç†æœåŠ¡å™¨...
            </div>
        </div>
        
        <div class="actions">
            <button class="btn primary" onclick="retryConnection()">é‡æ–°è¿æ¥</button>
            <button class="btn" onclick="openSettings()">ç½‘ç»œè®¾ç½®</button>
            <button class="btn" onclick="contactSupport()">æŠ€æœ¯æ”¯æŒ</button>
        </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let retryCount = 0;
        const maxRetries = 3;
        
        function updateNetworkStatus(status, message) {
            const networkStatus = document.getElementById('networkStatus');
            networkStatus.innerHTML = `${status} ${message}`;
        }
        
        function retryConnection() {
            if (retryCount < maxRetries) {
                retryCount++;
                updateNetworkStatus('ğŸ”„', `æ­£åœ¨å°è¯•é‡æ–°è¿æ¥... (${retryCount}/${maxRetries})`);

                // ç¦ç”¨é‡è¯•æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                const retryBtn = document.querySelector('.btn.primary');
                if (retryBtn) {
                    retryBtn.disabled = true;
                    retryBtn.textContent = `é‡è¯•ä¸­... (${retryCount}/${maxRetries})`;
                }

                // ä½¿ç”¨é€’å¢çš„å»¶è¿Ÿæ—¶é—´
                const delay = 2000 + (retryCount - 1) * 1000; // 2ç§’ã€3ç§’ã€4ç§’
                setTimeout(() => {
                    console.log(`ğŸ”„ ç¬¬${retryCount}æ¬¡é‡è¯•è¿æ¥`);
                    // å°è¯•é‡æ–°åŠ è½½åŸå§‹ç½‘ç«™
                    ipcRenderer.send('retry-main-site');

                    // é‡æ–°å¯ç”¨æŒ‰é’®
                    if (retryBtn) {
                        retryBtn.disabled = false;
                        retryBtn.textContent = 'é‡æ–°è¿æ¥';
                    }
                }, delay);
            } else {
                updateNetworkStatus('âŒ', 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ');

                // é‡ç½®é‡è¯•è®¡æ•°ï¼Œå…è®¸ç”¨æˆ·å†æ¬¡å°è¯•
                setTimeout(() => {
                    retryCount = 0;
                    updateNetworkStatus('âš ï¸', 'å¯ä»¥å†æ¬¡å°è¯•é‡æ–°è¿æ¥');
                }, 5000);
            }
        }
        
        function openSettings() {
            ipcRenderer.send('open-network-settings');
        }
        
        function contactSupport() {
            ipcRenderer.send('contact-support');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè·å–æˆæƒä¿¡æ¯å¹¶å¼€å§‹å°è¯•è¿æ¥
        window.addEventListener('load', () => {
            // è·å–æˆæƒä¿¡æ¯
            loadLicenseInfo();

            setTimeout(() => {
                retryConnection();
            }, 2000);
        });

        // è·å–å¹¶æ˜¾ç¤ºæˆæƒä¿¡æ¯
        async function loadLicenseInfo() {
            try {
                const licenseStatus = await ipcRenderer.invoke('get-license-status');
                if (licenseStatus && licenseStatus.valid) {
                    displayLicenseInfo(licenseStatus);
                }
            } catch (error) {
                console.log('è·å–æˆæƒä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæˆæƒä¿¡æ¯
        function displayLicenseInfo(licenseInfo) {
            console.log('ğŸ¨ æ˜¾ç¤ºæˆæƒä¿¡æ¯:', licenseInfo);

            const licenseInfoDiv = document.getElementById('licenseInfo');
            const remainingDaysSpan = document.getElementById('remainingDays');
            const expireDateSpan = document.getElementById('expireDate');

            // æ˜¾ç¤ºå‰©ä½™æ—¶é—´
            if (licenseInfo.isMinuteLicense && licenseInfo.remainingMinutes !== undefined) {
                // åˆ†é’Ÿçº§æˆæƒç æ˜¾ç¤ºå‰©ä½™åˆ†é’Ÿæ•°
                remainingDaysSpan.textContent = `${licenseInfo.remainingMinutes} åˆ†é’Ÿ`;

                // æ ¹æ®å‰©ä½™åˆ†é’Ÿæ•°è®¾ç½®é¢œè‰²
                if (licenseInfo.remainingMinutes > 30) {
                    remainingDaysSpan.style.color = '#4CAF50'; // ç»¿è‰²
                } else if (licenseInfo.remainingMinutes > 5) {
                    remainingDaysSpan.style.color = '#FF9800'; // æ©™è‰²
                } else {
                    remainingDaysSpan.style.color = '#F44336'; // çº¢è‰²
                }
            } else if (licenseInfo.remainingDays !== undefined) {
                // å¤©çº§æˆæƒç æ˜¾ç¤ºå‰©ä½™å¤©æ•°
                remainingDaysSpan.textContent = `${licenseInfo.remainingDays} å¤©`;

                // æ ¹æ®å‰©ä½™å¤©æ•°è®¾ç½®é¢œè‰²
                if (licenseInfo.remainingDays > 30) {
                    remainingDaysSpan.style.color = '#4CAF50'; // ç»¿è‰²
                } else if (licenseInfo.remainingDays > 7) {
                    remainingDaysSpan.style.color = '#FF9800'; // æ©™è‰²
                } else {
                    remainingDaysSpan.style.color = '#F44336'; // çº¢è‰²
                }
            }

            // æ˜¾ç¤ºåˆ°æœŸæ—¶é—´ï¼ˆå…¼å®¹å¤šç§æ•°æ®ç»“æ„ï¼‰
            let expireDate = null;

            // å°è¯•ä»ä¸åŒçš„æ•°æ®ç»“æ„ä¸­è·å–è¿‡æœŸæ—¶é—´
            if (licenseInfo.data && (licenseInfo.data.expires || licenseInfo.data.expiresAt)) {
                // æ–°çš„æ•°æ®ç»“æ„ï¼šlicenseInfo.data.expiresAt
                expireDate = new Date(licenseInfo.data.expires || licenseInfo.data.expiresAt);
            } else if (licenseInfo.licenseInfo && (licenseInfo.licenseInfo.expires || licenseInfo.licenseInfo.expiresAt)) {
                // checkLocalLicense è¿”å›çš„ç»“æ„ï¼šlicenseInfo.licenseInfo.expiresAt
                expireDate = new Date(licenseInfo.licenseInfo.expires || licenseInfo.licenseInfo.expiresAt);
            } else if (licenseInfo.expiryDate && licenseInfo.expiryDate !== 'æœªçŸ¥') {
                // ç›´æ¥çš„ expiryDate å­—æ®µ
                expireDate = new Date(licenseInfo.expiryDate);
            } else if (licenseInfo.expires || licenseInfo.expiresAt) {
                // ç›´æ¥çš„ expires/expiresAt å­—æ®µ
                expireDate = new Date(licenseInfo.expires || licenseInfo.expiresAt);
            }

            if (expireDate && !isNaN(expireDate.getTime())) {
                // æ˜¾ç¤ºå®Œæ•´çš„æ—¥æœŸå’Œæ—¶é—´
                expireDateSpan.textContent = expireDate.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                console.log('âœ… æˆåŠŸæ˜¾ç¤ºè¿‡æœŸæ—¶é—´:', expireDateSpan.textContent);
            } else {
                console.log('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¿‡æœŸæ—¶é—´æ•°æ®');
                expireDateSpan.textContent = '--';
            }

            // æ˜¾ç¤ºæˆæƒä¿¡æ¯åŒºåŸŸ
            licenseInfoDiv.style.display = 'block';
        }
        
        // ç›‘å¬è¿æ¥çŠ¶æ€æ›´æ–°
        ipcRenderer.on('connection-status', (event, status, message) => {
            updateNetworkStatus(status, message);
        });
    </script>

    <script>
        // çª—å£æ§åˆ¶æŒ‰é’®äº‹ä»¶å¤„ç†
        document.addEventListener('DOMContentLoaded', () => {
            const { ipcRenderer } = require('electron');

            const closeBtn = document.getElementById('closeBtn');
            const minimizeBtn = document.getElementById('minimizeBtn');

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    ipcRenderer.send('window-control', 'close');
                });
            }

            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', () => {
                    ipcRenderer.send('window-control', 'minimize');
                });
            }
        });
    </script>
</body>
</html>
